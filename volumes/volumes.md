# Volumes

- On-disk files in a Container are ephemeral, which presents some problems for non-trivial applications when running in Containers. 
- First, when a Container crashes, kubelet will restart it, but the files will be lost - the Container starts with a clean state. Second, when running Containers together in a Pod it is often necessary to share files between those Containers. 
- The Kubernetes **Volume abstraction** solves both of these problems.

**Docker Volumes** 
- Docker also has a concept of volumes, though it is somewhat looser and less managed. In Docker, a volume is simply a directory on disk or in another Container. 
- Lifetimes are not managed and until very recently there were only local-disk-backed volumes.

**Kubernetes Volumes** 
- A Kubernetes volume, on the other hand, has an explicit lifetime - the same as the Pod that encloses it. 
- A volume outlives any Containers that run within the Pod, and data is preserved across Container restarts.
- when a Pod ceases to exist, the volume will cease to exist, too.
- Kubernetes supports many types of volumes, and a Pod can use any number of them simultaneously.

-  *A volume is just a directory, possibly with some data in it, which is accessible to the Containers in a Pod*

**Simple Volume Exmaple** 

- Here container generate a file "number.out" and on pod its stored under "/opt" and due to volume mount same is stored on node as "/data". 
- if container is destroyed for any reason, file generated by container wil be stil availale at /data over node. 

![volumes](./images/volume.png)

```
kind: Pod
apiVersion: v1 
metadata:
  name: random-number-generator
spec:
  containers:
    - name: alpine-random-number-generator
      image: alpine
      command: ["/bin/bash","-c"]
      args: ["shuf -i 0-100 -n 1 >> /opt/number.out"]
      ### place where file number.out will be stored
      volumeMounts:
        - mountPath: /opt
          name: data-volume 
      
  volumes:
    - name: data-volume
      hostPath:
          ### place where file number.out will be stored on host
          path: /data
          type: Directory
```

here **hostPath** is one of storage spec for volume and this is not recommanded for multi node cluster.

Kubernetes supports several types of Volumes:

| awsElasticBlockStore | azureDisk          | gcePersistentDisk     | projected     |
|----------------------|--------------------|-----------------------|---------------|
| azureFile            | cephfs             | gitRepo (deprecated)  | rbd           |
| cinder               | configMap          | glusterfs             | secret        |
| csi                  | downwardAPI        | hostPath              | vsphereVolume |
| emptyDir             | fc (fibre channel) | local                 | storageos     |
| flexVolume           | flocker            | persistentVolumeClaim | scaleIO       |
| portworxVolume       | iscsi              | nfs                   | quobyte       |

# Persistent Volumes


- A PersistentVolume (PV) is a piece of storage in the cluster that has been provisioned by an administrator or dynamically provisioned using Storage Classes. 
- It is a resource in the cluster just like a node is a cluster resource. PVs are volume plugins like Volumes, but have a lifecycle independent of any individual Pod that uses the PV.
-  This API object captures the details of the implementation of the storage, be that NFS, iSCSI, or a cloud-provider-specific storage system.
- A PersistentVolumeClaim (PVC) is a request for storage by a user.


**A Kubernetes persistent volume has the following attributes**

- It is provisioned either dynamically or by an administrator
- Created with a particular filesystem
- Has a particular size
- Has identifying characteristics such as volume IDs and a name

In order for pods to start using these volumes, they need to be claimed (via a persistent volume claim) and the claim referenced in the spec for a pod. 

A Persistent Volume Claim describes the amount and characteristics of the storage required by the pod, finds any matching persistent volumes and claims these. Storage Classes describe default volume information (filesystem,size,block size etc).

![alt](./images/pv.png)